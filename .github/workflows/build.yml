name: Build MacWhisper

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build-intel:
    name: Build for Intel (x86_64)
    runs-on: macos-13  # GitHub's macos-13 runners are Intel-based
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          # Explicitly install wheels to avoid build issues
          pip install pyinstaller PyQt6 openai-whisper torch torchaudio numpy
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Build DMG (Intel)
        run: |
          chmod +x build_dmg.sh
          ./build_dmg.sh

      - name: Upload Intel DMG
        uses: actions/upload-artifact@v4
        with:
          name: MacWhisper-Intel-DMG
          path: dist/*.dmg

  build-silicon:
    name: Build for Apple Silicon (M1/M2)
    runs-on: macos-14  # GitHub's macos-14 runners are Apple Silicon (M1)
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller PyQt6 openai-whisper torch torchaudio numpy
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Build DMG (Silicon)
        run: |
          chmod +x build_dmg.sh
          ./build_dmg.sh

      - name: Upload Silicon DMG
        uses: actions/upload-artifact@v4
        with:
          name: MacWhisper-Silicon-DMG
          path: dist/*.dmg
